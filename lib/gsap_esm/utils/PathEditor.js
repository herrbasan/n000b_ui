/*!
 * PathEditor 3.2.6
 * https://greensock.com
 *
 * Copyright 2008-2020, GreenSock. All rights reserved.
 * Subject to the terms at https://greensock.com/standard-license or for
 * Club GreenSock members, the agreement issued with that membership.
 * @author: Jack Doyle, jack@greensock.com
*/
import{stringToRawPath,rawPathToString,bezierToPoints,simplifyPoints,pointsToSegment,subdivideSegment,getClosestData,copyRawPath,transformRawPath}from"./paths.js";import{getGlobalMatrix,Matrix2D}from"./matrix.js";var _doc,_supportsPointer,_win,_body,_CTRL,_ALT,_SHIFT,_CMD,_recentlyAddedAnchor,_tempDiv,_touchEventLookup,_copyElement,_coreInitted,_numbersExp=/(?:(-)?\d*\.?\d*(?:e[\-+]?\d+)?)[0-9]/gi,_selectionColor="#4e7fff",_minimumMovement=1,_DEG2RAD=Math.PI/180,_getTime=Date.now||function(){return(new Date).getTime()},_lastInteraction=0,_isPressed=0,_emptyFunc=function(){return!1},_interacted=function(){return _lastInteraction=_getTime()},_editingAxis={},_history=[],_point={},_temp=[],_comma=",",_selectedPaths=[],_preventDefault=function(t){t.preventDefault&&(t.preventDefault(),t.preventManipulation&&t.preventManipulation())},_createElement=function(t){return _doc.createElementNS?_doc.createElementNS("http://www.w3.org/1999/xhtml",t):_doc.createElement(t)},_createSVG=function(t,e,i){var s,n=_doc.createElementNS("http://www.w3.org/2000/svg",t),o=/([a-z])([A-Z])/g;for(s in(i=i||{}).class=i.class||"path-editor",i)void 0!==n.style[s]?n.style[s]=i[s]:n.setAttributeNS(null,s.replace(o,"$1-$2").toLowerCase(),i[s]);return e.appendChild(n),n},_identityMatrixObject={matrix:new Matrix2D},_getConsolidatedMatrix=function(t){return(t.transform&&t.transform.baseVal.consolidate()||_identityMatrixObject).matrix},_getConcatenatedTransforms=function(t){for(var e=_getConsolidatedMatrix(t),i=t.ownerSVGElement;(t=t.parentNode)&&t.ownerSVGElement===i;)e.multiply(_getConsolidatedMatrix(t));return"matrix("+e.a+","+e.b+","+e.c+","+e.d+","+e.e+","+e.f+")"},_addHistory=function(t){var e,i=[],s=t._selectedAnchors;for(e=0;e<s.length;e++)i[e]=s[e].i;_history.unshift({path:t,d:t.path.getAttribute("d"),transform:t.path.getAttribute("transform")||"",selectedIndexes:i}),_history.length>30&&(_history.length=30)},_round=function(t){return~~(1e3*t+(t<0?-.5:.5))/1e3},_getSquarePathData=function(t){return["M-"+(t=_round(t)),-t,t,-t,t,t,-t,t+"z"].join(_comma)},_getCirclePathData=function(t){var e=_round(.552284749831*t);return"M"+(t=_round(t))+",0C"+[t,e,e,t,0,t,-e,t,-t,e,-t,0,-t,-e,-e,-t,0,-t,e,-t,t,-e,t,0].join(_comma)+"z"},_checkDeselect=function(t){if(!t.target._gsSelection&&!_isPressed&&_getTime()-_lastInteraction>100){for(var e=_selectedPaths.length;--e>-1;)_selectedPaths[e].deselect();_selectedPaths.length=0}},_isMultiTouching=0,_addListener=function(t,e,i,s){if(t.addEventListener){var n=_touchEventLookup[e];s=s||{passive:!1},t.addEventListener(n||e,i,s),n&&e!==n&&"pointer"!==n.substr(0,7)&&t.addEventListener(e,i,s)}else t.attachEvent&&t.attachEvent("on"+e,i)},_removeListener=function(t,e,i){if(t.removeEventListener){var s=_touchEventLookup[e];t.removeEventListener(s||e,i),s&&e!==s&&"pointer"!==s.substr(0,7)&&t.removeEventListener(e,i)}else t.detachEvent&&t.detachEvent("on"+e,i)},_hasTouchID=function(t,e){for(var i=t.length;--i>-1;)if(t[i].identifier===e)return!0;return!1},_onMultiTouchDocumentEnd=function t(e){_isMultiTouching=e.touches&&_dragCount<e.touches.length,_removeListener(e.target,"touchend",t)},_onMultiTouchDocument=function(t){_isMultiTouching=t.touches&&_dragCount<t.touches.length,_addListener(t.target,"touchend",_onMultiTouchDocumentEnd)},_bind=function(t,e){return function(i){return t.call(e,i)}},_callback=function(t,e,i){var s=e.vars[t];return s&&s.call(e.vars.callbackScope||e,i||e),e},_resetSelection=function(){_copyElement.style.display="block",_copyElement.select(),_copyElement.style.display="none"},_initCore=function(){_doc=document,_win=window,_body=_doc.body,_tempDiv=_createElement("div"),(_copyElement=_createElement("textarea")).style.display="none",_body&&_body.appendChild(_copyElement),_touchEventLookup=function(t){for(var e=t.split(","),i=(void 0!==_tempDiv.onpointerdown?"pointerdown,pointermove,pointerup,pointercancel":void 0!==_tempDiv.onmspointerdown?"MSPointerDown,MSPointerMove,MSPointerUp,MSPointerCancel":t).split(","),s={},n=4;--n>-1;)s[e[n]]=i[n],s[i[n]]=e[n];return s}("touchstart,touchmove,touchend,touchcancel"),SVGElement.prototype.getTransformToElement=SVGElement.prototype.getTransformToElement||function(t){return t.getScreenCTM().inverse().multiply(this.getScreenCTM())},_doc.addEventListener("keydown",(function(t){var e,i,s,n,o=t.keyCode||t.which,a=t.key||o;if("Shift"===a||16===o)_SHIFT=!0;else if("Control"===a||17===o)_CTRL=!0;else if("Meta"===a||91===o)_CMD=!0;else if("Alt"===a||18===o)for(_ALT=!0,e=_selectedPaths.length;--e>-1;)_selectedPaths[e]._onPressAlt();else if(("z"===a||90===o)&&(_CTRL||_CMD)&&_history.length>1){if(_history.shift(),i=_history[0]){for((n=i.path).path.setAttribute("d",i.d),n.path.setAttribute("transform",i.transform),n.init(),s=n._anchors,e=0;e<s.length;e++)-1!==i.selectedIndexes.indexOf(s[e].i)&&n._selectedAnchors.push(s[e]);n._updateAnchors(),n.update(),n.vars.onUndo&&n.vars.onUndo.call(n)}}else if("Delete"===a||"Backspace"===a||8===o||46===o||63272===o||"d"===o&&(_CTRL||_CMD))for(e=_selectedPaths.length;--e>-1;)_selectedPaths[e]._deleteSelectedAnchors();else if(("a"===a||65===o)&&(_CMD||_CTRL))for(e=_selectedPaths.length;--e>-1;)_selectedPaths[e].select(!0)}),!0),_doc.addEventListener("keyup",(function(t){var e=t.key||t.keyCode||t.which;if("Shift"===e||16===e)_SHIFT=!1;else if("Control"===e||17===e)_CTRL=!1;else if("Meta"===e||91===e)_CMD=!1;else if("Alt"===e||18===e){_ALT=!1;for(var i=_selectedPaths.length;--i>-1;)_selectedPaths[i]._onReleaseAlt()}}),!0),_supportsPointer=!!_win.PointerEvent,_addListener(_doc,"mouseup",_checkDeselect),_addListener(_doc,"touchend",_checkDeselect),_addListener(_doc,"touchcancel",_emptyFunc),_addListener(_win,"touchmove",_emptyFunc),_body&&_body.addEventListener("touchstart",_emptyFunc),_coreInitted=1},_onPress=function(t){var e,i,s=this,n=getGlobalMatrix(s.target.parentNode,!0);this._matrix=this.target.transform.baseVal.getItem(0).matrix,this._ctm=n,_touchEventLookup[t.type]?(e=-1!==t.type.indexOf("touch")?t.currentTarget||t.target:_doc,_addListener(e,"touchend",s._onRelease),_addListener(e,"touchmove",s._onMove),_addListener(e,"touchcancel",s._onRelease),_addListener(_doc,"touchstart",_onMultiTouchDocument),_addListener(_win,"touchforcechange",_preventDefault)):(e=null,_addListener(_doc,"mousemove",s._onMove)),_supportsPointer||_addListener(_doc,"mouseup",s._onRelease),_preventDefault(t),_resetSelection(),t.changedTouches?(t=s.touch=t.changedTouches[0],s.touchID=t.identifier):t.pointerId?s.touchID=t.pointerId:s.touch=s.touchID=null,s._startPointerY=s.pointerY=t.pageY,s._startPointerX=s.pointerX=t.pageX,s._startElementX=s._matrix.e,s._startElementY=s._matrix.f,1===this._ctm.a&&0===this._ctm.b&&0===this._ctm.c&&1===this._ctm.d?this._ctm=null:(i=s._startPointerX*this._ctm.a+s._startPointerY*this._ctm.c+this._ctm.e,s._startPointerY=s._startPointerX*this._ctm.b+s._startPointerY*this._ctm.d+this._ctm.f,s._startPointerX=i),s.isPressed=_isPressed=!0,s.touchEventTarget=e,s.vars.onPress&&s.vars.onPress.call(s.vars.callbackScope||s,s.pointerEvent)},_onMove=function(t){var e,i,s=this,n=t;if(s._enabled&&!_isMultiTouching&&s.isPressed&&t){if(s.pointerEvent=t,e=t.changedTouches){if((t=e[0])!==s.touch&&t.identifier!==s.touchID){for(i=e.length;--i>-1&&(t=e[i]).identifier!==s.touchID;);if(i<0)return}}else if(t.pointerId&&s.touchID&&t.pointerId!==s.touchID)return;_preventDefault(n),s.setPointerPosition(t.pageX,t.pageY),s.vars.onDrag&&s.vars.onDrag.call(s.vars.callbackScope||s,s.pointerEvent)}},_onRelease=function(t,e){var i=this;if(i._enabled&&i.isPressed&&(!t||null==i.touchID||e||!(t.pointerId&&t.pointerId!==i.touchID||t.changedTouches&&!_hasTouchID(t.changedTouches,i.touchID)))){_interacted(),i.isPressed=_isPressed=!1;var s,n,o=t,a=i.isDragging,r=i.touchEventTarget;if(r?(_removeListener(r,"touchend",i._onRelease),_removeListener(r,"touchmove",i._onMove),_removeListener(r,"touchcancel",i._onRelease),_removeListener(_doc,"touchstart",_onMultiTouchDocument)):_removeListener(_doc,"mousemove",i._onMove),_supportsPointer||(_removeListener(_doc,"mouseup",i._onRelease),t&&t.target&&_removeListener(t.target,"mouseup",i._onRelease)),a?i.isDragging=!1:i.vars.onClick&&i.vars.onClick.call(i.vars.callbackScope||i,o),t){if((s=t.changedTouches)&&(t=s[0])!==i.touch&&t.identifier!==i.touchID){for(n=s.length;--n>-1&&(t=s[n]).identifier!==i.touchID;);if(n<0)return}i.pointerEvent=o,i.pointerX=t.pageX,i.pointerY=t.pageY}return o&&!a&&i.vars.onDragRelease?i.vars.onDragRelease.call(i,i.pointerEvent):(o&&_preventDefault(o),i.vars.onRelease&&i.vars.onRelease.call(i.vars.callbackScope||i,i.pointerEvent)),a&&i.vars.onDragEnd&&i.vars.onDragEnd.call(i.vars.callbackScope||i,i.pointerEvent),!0}},_createSegmentAnchors=function(t,e,i,s){var n,o=t[e].length,a=[];for(n=0;n<o;n+=6)a.push(new Anchor(i,t,e,n,s));return a},_getLength=function(t,e,i){var s=t[i]-t[e],n=t[i+1]-t[e+1];return Math.sqrt(s*s+n*n)},DraggableSVG=function(){function t(t,e){this.target="string"==typeof t?_doc.querySelectorAll(t)[0]:t,this.vars=e||{},this._onPress=_bind(_onPress,this),this._onMove=_bind(_onMove,this),this._onRelease=_bind(_onRelease,this),this.target.setAttribute("transform",(this.target.getAttribute("transform")||"")+" translate(0,0)"),this._matrix=_getConsolidatedMatrix(this.target),this.x=this._matrix.e,this.y=this._matrix.f,this.snap=e.snap,isNaN(e.maxX)&&isNaN(e.minX)?this._bounds=0:(this._bounds=1,this.maxX=+e.maxX,this.minX=+e.minX),this.enabled(!0)}var e=t.prototype;return e.setPointerPosition=function(t,e){var i,s,n,o,a,r=1e3;this.pointerX=t,this.pointerY=e,this._ctm&&(a=t*this._ctm.a+e*this._ctm.c+this._ctm.e,e=t*this._ctm.b+e*this._ctm.d+this._ctm.f,t=a),s=e-this._startPointerY,i=t-this._startPointerX,s<_minimumMovement&&s>-_minimumMovement&&(s=0),i<_minimumMovement&&i>-_minimumMovement&&(i=0),n=((this._startElementX+i)*r|0)/r,o=((this._startElementY+s)*r|0)/r,this.snap&&!_SHIFT&&(_point.x=n,_point.y=o,this.snap.call(this,_point),n=_point.x,o=_point.y),this.x===n&&this.y===o||(this._matrix.f=this.y=o,this._matrix.e=this.x=n,!this.isDragging&&this.isPressed&&(this.isDragging=!0,_callback("onDragStart",this,this.pointerEvent)))},e.enabled=function(t){return arguments.length?(this._enabled=t,t?(_supportsPointer||_addListener(this.target,"mousedown",this._onPress),_addListener(this.target,"touchstart",this._onPress),_addListener(this.target,"click",this._onClick,!0)):(e=this.isDragging,_removeListener(this.target,"mousedown",this._onPress),_removeListener(this.target,"touchstart",this._onPress),_removeListener(_win,"touchforcechange",_preventDefault),_removeListener(this.target,"click",this._onClick),this.touchEventTarget&&(_removeListener(this.touchEventTarget,"touchcancel",this._onRelease),_removeListener(this.touchEventTarget,"touchend",this._onRelease),_removeListener(this.touchEventTarget,"touchmove",this._onMove)),_removeListener(_doc,"mouseup",this._onRelease),_removeListener(_doc,"mousemove",this._onMove),this.isDragging=this.isPressed=!1,e&&_callback("onDragEnd",this,this.pointerEvent)),this):this._enabled;var e},e.endDrag=function(t){this._onRelease(t)},t}(),Anchor=function(){function t(t,e,i,s,n){this.editor=t,this.element=_createSVG("path",t._selection,{fill:_selectionColor,stroke:_selectionColor,strokeWidth:2,vectorEffect:"non-scaling-stroke"}),this.update(e,i,s),this.element._gsSelection=!0,this.vars=n||{},this._draggable=new DraggableSVG(this.element,{callbackScope:this,onDrag:this.onDrag,snap:this.vars.snap,onPress:this.onPress,onRelease:this.onRelease,onClick:this.onClick,onDragEnd:this.onDragEnd})}var e=t.prototype;return e.onPress=function(){_callback("onPress",this)},e.onClick=function(){_callback("onClick",this)},e.onDrag=function(){var t=this.segment;this.vars.onDrag.call(this.vars.callbackScope||this,this,this._draggable.x-t[this.i],this._draggable.y-t[this.i+1])},e.onDragEnd=function(){_callback("onDragEnd",this)},e.onRelease=function(){_callback("onRelease",this)},e.update=function(t,e,i){t&&(this.rawPath=t),arguments.length<=1?(e=this.j,i=this.i):(this.j=e,this.i=i);var s=this.smooth,n=this.rawPath[e];this.segment=n,this.smooth=i&&i<n.length-2&&Math.abs(Math.atan2(n[i+1]-n[i-1],n[i]-n[i-2])-Math.atan2(n[i+3]-n[i+1],n[i+2]-n[i]))<.09?2:0,this.smooth!==s&&this.element.setAttribute("d",this.smooth?this.editor._circleHandle:this.editor._squareHandle),this.element.setAttribute("transform","translate("+n[i]+","+n[i+1]+")")},t}();export var PathEditor=function(){function t(t,e){e=e||{},_coreInitted||_initCore(),this.vars=e,this.path="string"==typeof t?_doc.querySelectorAll(t)[0]:t,this._g=_createSVG("g",this.path.ownerSVGElement,{class:"path-editor-g path-editor"}),this._selectionHittest=_createSVG("path",this._g,{stroke:"transparent",strokeWidth:16,fill:"none",vectorEffect:"non-scaling-stroke"}),this._selection=e._selection||_createSVG("g",this._g,{class:"path-editor-selection path-editor"}),this._selectionPath=_createSVG("path",this._selection,{stroke:_selectionColor,strokeWidth:2,fill:"none",vectorEffect:"non-scaling-stroke"}),this._selectedAnchors=[],this._line1=_createSVG("polyline",this._selection,{stroke:_selectionColor,strokeWidth:2,vectorEffect:"non-scaling-stroke"}),this._line2=_createSVG("polyline",this._selection,{stroke:_selectionColor,strokeWidth:2,vectorEffect:"non-scaling-stroke"}),this._line1.style.pointerEvents=this._line2.style.pointerEvents=this._selectionPath.style.pointerEvents="none",this._enabled=!0;var i=this.path.parentNode.getScreenCTM().inverse(),s=(i.a+i.d)/2*(e.handleSize||5);this._squareHandle=_getSquarePathData(s),this._circleHandle=_getCirclePathData(1.15*s),this._handle1=_createSVG("path",this._selection,{d:this._squareHandle,fill:_selectionColor,stroke:"transparent",strokeWidth:6}),this._handle2=_createSVG("path",this._selection,{d:this._squareHandle,fill:_selectionColor,stroke:"transparent",strokeWidth:6}),this._handle1._draggable=new DraggableSVG(this._handle1,{onDrag:this._onDragHandle1,callbackScope:this,onPress:this._onPressHandle1,onRelease:this._onReleaseHandle,onClick:this._onClickHandle1,snap:e.handleSnap}),this._handle2._draggable=new DraggableSVG(this._handle2,{onDrag:this._onDragHandle2,callbackScope:this,onPress:this._onPressHandle2,onRelease:this._onReleaseHandle,onClick:this._onClickHandle2,snap:e.handleSnap}),this._handle1.style.visibility=this._handle2.style.visibility="hidden";for(var n=[this._handle1,this._handle2,this._line1,this._line2,this._selection,this._selectionPath,this._selectionHittest],o=n.length;--o>-1;)n[o]._gsSelection=!0;!1!==e.draggable&&(this._draggable=new DraggableSVG(this._selectionHittest,{callbackScope:this,onPress:this.select,onRelease:this._onRelease,onDrag:this._onDragPath,onDragEnd:this._saveState,maxX:this.vars.maxX,minX:this.vars.minX})),this.init(),this._selection.style.visibility=!1===e.selected?"hidden":"visible",!1!==e.selected&&(this.path._gsSelection=!0,_selectedPaths.push(this)),this._saveState(),_supportsPointer||(_addListener(this._selectionHittest,"mousedown",_bind(this._onClickSelectionPath,this)),_addListener(this._selectionHittest,"mouseup",_bind(this._onRelease,this))),_addListener(this._selectionHittest,"touchstart",_bind(this._onClickSelectionPath,this)),_addListener(this._selectionHittest,"touchend",_bind(this._onRelease,this))}var e=t.prototype;return e._onRelease=function(t){var e=this._editingAnchor;e&&(_editingAxis.x=e.segment[e.i],_editingAxis.y=e.segment[e.i+1]),_removeListener(_win,"touchforcechange",_preventDefault),_callback("onRelease",this,t)},e.init=function(){var t,e,i=this.path.getAttribute("d"),s=stringToRawPath(i),n=this.path.getAttribute("transform")||"translate(0,0)",o=!this._rawPath||s.totalPoints!==this._rawPath.totalPoints||s.length!==this._rawPath.length,a={callbackScope:this,snap:this.vars.anchorSnap,onDrag:this._onDragAnchor,onPress:this._onPressAnchor,onRelease:this._onRelease,onClick:this._onClickAnchor,onDragEnd:this._onDragEndAnchor,maxX:this.vars.maxX,minX:this.vars.minX};if(o&&this._anchors&&this._anchors.length){for(e=0;e<this._anchors.length;e++)this._anchors[e].element.parentNode.removeChild(this._anchors[e].element),this._anchors[e]._draggable.enabled(!1);this._selectedAnchors.length=0}if(this._rawPath=s,o){if(this._anchors=_createSegmentAnchors(s,0,this,a),(t=s.length)>1)for(e=1;e<t;e++)this._anchors=this._anchors.concat(_createSegmentAnchors(s,e,this,a))}else for(e=this._anchors.length;--e>-1;)this._anchors[e].update(s);return this._selection.appendChild(this._handle1),this._selection.appendChild(this._handle2),this._selectionPath.setAttribute("d",i),this._selectionHittest.setAttribute("d",i),this._g.setAttribute("transform",_getConcatenatedTransforms(this.path.parentNode)||"translate(0,0)"),this._selection.setAttribute("transform",n),this._selectionHittest.setAttribute("transform",n),this._updateAnchors(),this},e._saveState=function(){_addHistory(this)},e._onClickSelectionPath=function(t){if("hidden"===this._selection.style.visibility)this.select();else if(_ALT||t&&t.altKey){var e,i,s,n,o,a,r={callbackScope:this,snap:this.vars.anchorSnap,onDrag:this._onDragAnchor,onPress:this._onPressAnchor,onRelease:this._onRelease,onClick:this._onClickAnchor,onDragEnd:this._onDragEndAnchor,maxX:this.vars.maxX,minX:this.vars.minX},h=this._selection.getScreenCTM().inverse();for(this._draggable&&this._draggable._onRelease(t),h&&(n=t.clientX*h.a+t.clientY*h.c+h.e,o=t.clientX*h.b+t.clientY*h.d+h.f),a=getClosestData(this._rawPath,n,o),subdivideSegment(this._rawPath[a.j],a.i,a.t),e=a.i+6,i=0;i<this._anchors.length;i++)this._anchors[i].i>=e&&(this._anchors[i].i+=6);s=new Anchor(this,this._rawPath,a.j,e,r),this._selection.appendChild(this._handle1),this._selection.appendChild(this._handle2),s._draggable._onPress(t),_recentlyAddedAnchor=s,this._anchors.push(s),this._selectedAnchors.length=0,this._selectedAnchors.push(s),this._updateAnchors(),this.update(),this._saveState()}_resetSelection(),_addListener(_win,"touchforcechange",_preventDefault),_callback("onPress",this)},e._onClickHandle1=function(){var t=this._editingAnchor,e=t.i,i=t.segment;_ALT&&Math.abs(i[e]-i[e-2])<5&&Math.abs(i[e+1]-i[e-1])<5&&this._onClickAnchor(t)},e._onClickHandle2=function(){var t=this._editingAnchor,e=t.i,i=t.segment;_ALT&&Math.abs(i[e]-i[e+2])<5&&Math.abs(i[e+1]-i[e+3])<5&&this._onClickAnchor(t)},e._onDragEndAnchor=function(t){_recentlyAddedAnchor=null,this._saveState()},e.isSelected=function(){return this._selectedAnchors.length>0},e.select=function(t){if(this._selection.style.visibility="visible",this._editingAnchor=null,this.path._gsSelection=!0,!0===t)for(var e=this._anchors.length;--e>-1;)this._selectedAnchors[e]=this._anchors[e];return-1===_selectedPaths.indexOf(this)&&_selectedPaths.push(this),this._updateAnchors(),this},e.deselect=function(){return this._selection.style.visibility="hidden",this._selectedAnchors.length=0,this._editingAnchor=null,this.path._gsSelection=!1,_selectedPaths.splice(_selectedPaths.indexOf(this),1),this._updateAnchors(),this},e._onDragPath=function(t){var e=this._selectionHittest.getAttribute("transform")||"translate(0,0)";this._selection.setAttribute("transform",e),this.path.setAttribute("transform",e)},e._onPressAnchor=function(t){-1===this._selectedAnchors.indexOf(t)?(_SHIFT||(this._selectedAnchors.length=0),this._selectedAnchors.push(t)):_SHIFT&&(this._selectedAnchors.splice(this._selectedAnchors.indexOf(t),1),t._draggable.endDrag()),_editingAxis.x=t.segment[t.i],_editingAxis.y=t.segment[t.i+1],this._updateAnchors(),_callback("onPress",this)},e._deleteSelectedAnchors=function(){for(var t,e,i,s=this._selectedAnchors,n=s.length;--n>-1;)for((t=s[n]).element.parentNode.removeChild(t.element),t._draggable.enabled(!1),(e=t.i)?e<t.segment.length-2?t.segment.splice(e-2,6):t.segment.splice(e-4,6):t.segment.splice(e,6),s.splice(n,1),this._anchors.splice(this._anchors.indexOf(t),1),i=0;i<this._anchors.length;i++)this._anchors[i].i>=e&&(this._anchors[i].i-=6);this._updateAnchors(),this.update(),this._saveState(),this.vars.onDeleteAnchor&&this.vars.onDeleteAnchor.call(this.vars.callbackScope||this)},e._onClickAnchor=function(t){var e,i,s,n,o,a,r=t.i,h=t.segment,l=1e3,c=!r||r>=h.length-2;_ALT&&_recentlyAddedAnchor!==t&&this._editingAnchor?(t.smooth=!t.smooth,c&&(t.smooth=!1),t.element.setAttribute("d",t.smooth?this._circleHandle:this._squareHandle),t.smooth&&!c?(e=((e=Math.atan2(h[r+1]-h[r-1],h[r]-h[r-2]))+(i=Math.atan2(h[r+3]-h[r+1],h[r+2]-h[r])))/2,s=_getLength(h,r-2,r),n=_getLength(h,r,r+2),s<.2&&(s=_getLength(h,r,r-6)/4,e=i||Math.atan2(h[r+7]-h[r-5],h[r+6]-h[r-6])),n<.2&&(n=_getLength(h,r,r+6)/4,i=e||Math.atan2(h[r+7]-h[r-5],h[r+6]-h[r-6])),o=Math.sin(e),a=Math.cos(e),Math.abs(i-e)<Math.PI/2&&(o=-o,a=-a),h[r-2]=((h[r]+a*s)*l|0)/l,h[r-1]=((h[r+1]+o*s)*l|0)/l,h[r+2]=((h[r]-a*n)*l|0)/l,h[r+3]=((h[r+1]-o*n)*l|0)/l,this._updateAnchors(),this.update(),this._saveState()):t.smooth||c||(r&&(h[r-2]=h[r],h[r-1]=h[r+1]),r<h.length-2&&(h[r+2]=h[r],h[r+3]=h[r+1]),this._updateAnchors(),this.update(),this._saveState())):_SHIFT||(this._selectedAnchors.length=0,this._selectedAnchors.push(t)),_recentlyAddedAnchor=null,this._updateAnchors()},e._updateAnchors=function(){var t,e,i,s=1===this._selectedAnchors.length?this._selectedAnchors[0]:null,n=s?s.segment:null;for(this._editingAnchor=s,t=0;t<this._anchors.length;t++)this._anchors[t].element.style.fill=-1!==this._selectedAnchors.indexOf(this._anchors[t])?_selectionColor:"white";s&&(this._handle1.setAttribute("d",s.smooth?this._circleHandle:this._squareHandle),this._handle2.setAttribute("d",s.smooth?this._circleHandle:this._squareHandle)),t=s?s.i:0,s&&t?(e=n[t-2],i=n[t-1],this._handle1.style.visibility=this._line1.style.visibility=_ALT||e!==n[t]||i!==n[t+1]?"visible":"hidden",this._handle1.setAttribute("transform","translate("+e+_comma+i+")"),this._line1.setAttribute("points",e+_comma+i+_comma+n[t]+_comma+n[t+1])):this._handle1.style.visibility=this._line1.style.visibility="hidden",s&&t<n.length-2?(e=n[t+2],i=n[t+3],this._handle2.style.visibility=this._line2.style.visibility=_ALT||e!==n[t]||i!==n[t+1]?"visible":"hidden",this._handle2.setAttribute("transform","translate("+e+_comma+i+")"),this._line2.setAttribute("points",n[t]+_comma+n[t+1]+_comma+e+_comma+i)):this._handle2.style.visibility=this._line2.style.visibility="hidden"},e._onPressAlt=function(){var t=this._editingAnchor;t&&(t.i&&(this._handle1.style.visibility=this._line1.style.visibility="visible"),t.i<t.segment.length-2&&(this._handle2.style.visibility=this._line2.style.visibility="visible"))},e._onReleaseAlt=function(){var t,e,i=this._editingAnchor;i&&((t=i.segment)[e=i.i]===t[e-2]&&t[e+1]===t[e-1]&&(this._handle1.style.visibility=this._line1.style.visibility="hidden"),t[e]===t[e+2]&&t[e+1]===t[e+3]&&(this._handle2.style.visibility=this._line2.style.visibility="hidden"))},e._onPressHandle1=function(){this._editingAnchor.smooth&&(this._oppositeHandleLength=_getLength(this._editingAnchor.segment,this._editingAnchor.i,this._editingAnchor.i+2)),_callback("onPress",this)},e._onPressHandle2=function(){this._editingAnchor.smooth&&(this._oppositeHandleLength=_getLength(this._editingAnchor.segment,this._editingAnchor.i-2,this._editingAnchor.i)),_callback("onPress",this)},e._onReleaseHandle=function(t){this._onRelease(t),this._saveState()},e._onDragHandle1=function(){var t,e=this._editingAnchor,i=e.segment,s=e.i,n=1e3,o=this._handle1._draggable.x,a=this._handle1._draggable.y;i[s-2]=o=(o*n|0)/n,i[s-1]=a=(a*n|0)/n,e.smooth&&(_ALT?(e.smooth=!1,e.element.setAttribute("d",this._squareHandle),this._handle1.setAttribute("d",this._squareHandle),this._handle2.setAttribute("d",this._squareHandle)):(t=Math.atan2(i[s+1]-a,i[s]-o),o=this._oppositeHandleLength*Math.cos(t),a=this._oppositeHandleLength*Math.sin(t),i[s+2]=((i[s]+o)*n|0)/n,i[s+3]=((i[s+1]+a)*n|0)/n)),this.update()},e._onDragHandle2=function(){var t,e=this._editingAnchor,i=e.segment,s=e.i,n=1e3,o=this._handle2._draggable.x,a=this._handle2._draggable.y;i[s+2]=o=(o*n|0)/n,i[s+3]=a=(a*n|0)/n,e.smooth&&(_ALT?(e.smooth=!1,e.element.setAttribute("d",this._squareHandle),this._handle1.setAttribute("d",this._squareHandle),this._handle2.setAttribute("d",this._squareHandle)):(t=Math.atan2(i[s+1]-a,i[s]-o),o=this._oppositeHandleLength*Math.cos(t),a=this._oppositeHandleLength*Math.sin(t),i[s-2]=((i[s]+o)*n|0)/n,i[s-1]=((i[s+1]+a)*n|0)/n)),this.update()},e._onDragAnchor=function(t,e,i){var s,n,o,a,r=this._selectedAnchors,h=r.length,l=1e3;for(n=0;n<h;n++)s=(a=r[n]).i,o=a.segment,s&&(o[s-2]=((o[s-2]+e)*l|0)/l,o[s-1]=((o[s-1]+i)*l|0)/l),o[s]=((o[s]+e)*l|0)/l,o[s+1]=((o[s+1]+i)*l|0)/l,s<o.length-2&&(o[s+2]=((o[s+2]+e)*l|0)/l,o[s+3]=((o[s+3]+i)*l|0)/l),a!==t&&a.element.setAttribute("transform","translate("+o[s]+_comma+o[s+1]+")");this.update()},e.enabled=function(t){if(!arguments.length)return this._enabled;for(var e=this._anchors.length;--e>-1;)this._anchors[e]._draggable.enabled(t);return this._enabled=t,this._handle1._draggable.enabled(t),this._handle2._draggable.enabled(t),this._draggable&&this._draggable.enabled(t),t?this._selection.parentNode||(this.path.ownerSVGElement.appendChild(this._selectionHittest),this.path.ownerSVGElement.appendChild(this._selection),this.init(),this._saveState()):(this.deselect(),this.path.ownerSVGElement.removeChild(this._selectionHittest),this.path.ownerSVGElement.removeChild(this._selection)),this._updateAnchors(),this.update()},e.update=function(t){var e,i,s,n,o="",a=this._editingAnchor;if(t&&this.init(),a&&(e=a.i,i=a.segment,e&&(s=i[e-2],n=i[e-1],this._handle1.setAttribute("transform","translate("+s+_comma+n+")"),this._line1.setAttribute("points",s+_comma+n+_comma+i[e]+_comma+i[e+1])),e<i.length-2&&(s=i[e+2],n=i[e+3],this._handle2.setAttribute("transform","translate("+s+_comma+n+")"),this._line2.setAttribute("points",i[e]+_comma+i[e+1]+_comma+s+_comma+n))),t)o=this.path.getAttribute("d");else{for(e=0;e<this._rawPath.length;e++)(i=this._rawPath[e]).length>7&&(o+="M"+i[0]+_comma+i[1]+"C"+i.slice(2).join(_comma));this.path.setAttribute("d",o),this._selectionPath.setAttribute("d",o),this._selectionHittest.setAttribute("d",o)}return this.vars.onUpdate&&this._enabled&&_callback("onUpdate",this,o),this},e.getRawPath=function(t,e,i){if(t){var s=_getConsolidatedMatrix(this.path);return transformRawPath(copyRawPath(this._rawPath),1,0,0,1,s.e+(e||0),s.f+(i||0))}return this._rawPath},e.getString=function(t,e,i){if(t){var s=_getConsolidatedMatrix(this.path);return rawPathToString(transformRawPath(copyRawPath(this._rawPath),1,0,0,1,s.e+(e||0),s.f+(i||0)))}return this.path.getAttribute("d")},e.getNormalizedSVG=function(t,e,i,s){var n,o,a,r,h,l,c=this._rawPath[0],_=-1*c[0],d=0===e?0:-(e||c[1]),u=c.length,g=1/(c[u-2]+_),m=-t||c[u-1]+d,p=1e3;for(_temp.length=0,m=m?1/m:-g,g*=p,m*=p,o=0;o<u;o+=2)_temp[o]=((c[o]+_)*g|0)/p,_temp[o+1]=((c[o+1]+d)*m|0)/p;if(s){for(n=[],u=_temp.length,o=2;o<u;o+=6)a=_temp[o-2],r=_temp[o-1],h=_temp[o+4],l=_temp[o+5],n.push(a,r,h,l),bezierToPoints(a,r,_temp[o],_temp[o+1],_temp[o+2],_temp[o+3],h,l,.001,n,n.length-2);for(a=n[0],u=n.length,o=2;o<u;o+=2){if((h=n[o])<a||h>1||h<0){s();break}a=h}}return i&&8===u&&0===_temp[0]&&0===_temp[1]&&1===_temp[u-2]&&1===_temp[u-1]?_temp.slice(2,6).join(","):(_temp[2]="C"+_temp[2],"M"+_temp.join(","))},t}();PathEditor.simplifyPoints=simplifyPoints,PathEditor.pointsToSegment=pointsToSegment,PathEditor.simplifySVG=function(t,e){var i,s,n,o,a,r,h,l,c,_,d,u;if(_=(e=e||{}).tolerance||1,c=e.precision||1/_,u=(void 0===e.cornerThreshold?18:+e.cornerThreshold)*_DEG2RAD,"string"!=typeof t&&(t=(i=t).getAttribute("d")),"#"!==t.charAt(0)&&"."!==t.charAt(0)||(i=_doc.querySelector(t))&&(t=i.getAttribute("d")),s=!1!==e.curved||/[achqstvz]/gi.test(t)?stringToRawPath(t)[0]:t.match(_numbersExp),!1!==e.curved){for(l=s,s=[],d=l.length,n=2;n<d;n+=6)o=+l[n-2],r=+l[n-1],a=+l[n+4],h=+l[n+5],s.push(_round(o),_round(r),_round(a),_round(h)),bezierToPoints(o,r,+l[n],+l[n+1],+l[n+2],+l[n+3],a,h,1/(2e5*c),s,s.length-2);(s=pointsToSegment(simplifyPoints(s,_),e.curviness,u))[2]="C"+s[2]}else s=simplifyPoints(s,_);return t="M"+s.join(","),i&&i.setAttribute("d",t),t},PathEditor.create=function(t,e){return new PathEditor(t,e)},PathEditor.editingAxis=_editingAxis,PathEditor.getSnapFunction=function(t){var e=t.radius||2,i=1e20,s=t.x||0===t.x?t.x:t.width?0:-i,n=t.y||0===t.y?t.y:t.height?0:-i,o=s+(t.width||i*i),a=n+(t.height||i*i),r=!1!==t.containX,h=!1!==t.containY,l=t.axis,c=t.gridSize;return e*=e,function(t){var i,_,d,u,g=t.x,m=t.y;r&&g<s||(d=g-s)*d<e?g=s:(r&&g>o||(d=o-g)*d<e)&&(g=o),h&&m<n||(u=m-n)*u<e?m=n:(h&&m>a||(u=a-m)*u<e)&&(m=a),l&&(d=g-l.x,u=m-l.y,d*d<e&&(g=l.x),u*u<e&&(m=l.y)),c&&(d=(i=s+Math.round((g-s)/c)*c)-g)*d+(u=(_=n+Math.round((m-n)/c)*c)-m)*u<e&&(g=i,m=_),t.x=g,t.y=m}},PathEditor.version="3.2.6";export{PathEditor as default};